{"version":3,"sources":["screentime.js"],"names":["factory","define","amd","module","exports","require","jQuery","$","defaults","fields","percentOnScreen","reportInterval","googleAnalytics","callback","screentime","options","extend","parseInt","replace","universalGA","classicGA","counter","cache","log","looker","started","Field","elem","this","selector","$elem","name","top","offset","height","bottom","width","Viewport","$window","window","scrollTop","checkViewport","viewport","each","key","val","field","buffered","onScreen","report","data","time","ga","nonInteraction","_gaq","push","sendGAEvent","isEmptyObject","call","startTimers","setInterval","reporter","stopTimers","clearInterval","length","visibly","q","document","p","undefined","prefixes","props","m","visibleCallbacks","hiddenCallbacks","genericCallbacks","_callbacks","cachedPrefix","fn","onVisible","i","onHidden","getPrefix","b","visibilityState","_getProp","hidden","visibilitychange","t","isSupported","_execute","_visible","_hidden","_nativeSwitch","_listen","addEventListener","apply","arguments","attachEvent","init","reset","index"],"mappings":"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","file":"screentime.js","sourcesContent":["/*!\n * @preserve\n * Screentime.js | v0.2.0\n * Copyright (c) 2016 Rob Flaherty (@robflaherty)\n * Licensed under the MIT and GPL licenses.\n */\n\n/* Universal module definition */\n\n(function(factory) {\n  if (typeof define === 'function' && define.amd) {\n    // AMD\n    define(['jquery'], factory);\n  } else if (typeof module === 'object' && module.exports) {\n    // CommonJS\n    module.exports = factory(require('jquery'));\n  } else {\n    // Browser globals\n    factory(jQuery);\n  }\n}(function($) {\n\n  /* Screentime */\n\n  var defaults = {\n    fields: [],\n    percentOnScreen: '50%',\n    reportInterval: 10,\n    googleAnalytics: false,\n    callback: function(){}\n  };\n\n  $.screentime = function(options) {\n    options = $.extend({}, defaults, options);\n\n    // Convert perecent string to number\n    options.percentOnScreen = parseInt(options.percentOnScreen.replace('%', ''), 10);\n\n    var counter = {};\n    var cache = {};\n    var log = {};\n    var looker = null;\n    var started = false;\n    var universalGA, classicGA;\n\n    if (!options.fields.length) {\n      return;\n    }\n\n    if (options.googleAnalytics) {\n\n      if (typeof ga === \"function\") {\n        universalGA = true;\n      }\n\n      if (typeof _gaq !== \"undefined\" && typeof _gaq.push === \"function\") {\n        classicGA = true;\n      }\n\n    }\n\n    /*\n     * Utilities\n     */\n\n    /*!\n     * visibly - v0.6 Aug 2011 - Page Visibility API Polyfill\n     * http://github.com/addyosmani\n     * Copyright (c) 2011 Addy Osmani\n     * Dual licensed under the MIT and GPL licenses.\n     *\n     * Methods supported:\n     * visibly.onVisible(callback)\n     * visibly.onHidden(callback)\n     * visibly.hidden()\n     * visibly.visibilityState()\n     * visibly.visibilitychange(callback(state));\n     */\n\n    (function(){window.visibly={q:document,p:undefined,prefixes:[\"webkit\",\"ms\",\"o\",\"moz\",\"khtml\"],props:[\"VisibilityState\",\"visibilitychange\",\"Hidden\"],m:[\"focus\",\"blur\"],visibleCallbacks:[],hiddenCallbacks:[],genericCallbacks:[],_callbacks:[],cachedPrefix:\"\",fn:null,onVisible:function(i){if(typeof i==\"function\"){this.visibleCallbacks.push(i)}},onHidden:function(i){if(typeof i==\"function\"){this.hiddenCallbacks.push(i)}},getPrefix:function(){if(!this.cachedPrefix){for(var i=0;b=this.prefixes[i++];){if(b+this.props[2]in this.q){this.cachedPrefix=b;return this.cachedPrefix}}}},visibilityState:function(){return this._getProp(0)},hidden:function(){return this._getProp(2)},visibilitychange:function(i){if(typeof i==\"function\"){this.genericCallbacks.push(i)}var t=this.genericCallbacks.length;if(t){if(this.cachedPrefix){while(t--){this.genericCallbacks[t].call(this,this.visibilityState())}}else{while(t--){this.genericCallbacks[t].call(this,arguments[0])}}}},isSupported:function(i){return this.cachedPrefix+this.props[2]in this.q},_getProp:function(i){return this.q[this.cachedPrefix+this.props[i]]},_execute:function(i){if(i){this._callbacks=i==1?this.visibleCallbacks:this.hiddenCallbacks;var t=this._callbacks.length;while(t--){this._callbacks[t]()}}},_visible:function(){window.visibly._execute(1);window.visibly.visibilitychange.call(window.visibly,\"visible\")},_hidden:function(){window.visibly._execute(2);window.visibly.visibilitychange.call(window.visibly,\"hidden\")},_nativeSwitch:function(){this[this._getProp(2)?\"_hidden\":\"_visible\"]()},_listen:function(){try{if(!this.isSupported()){if(this.q.addEventListener){window.addEventListener(this.m[0],this._visible,1);window.addEventListener(this.m[1],this._hidden,1)}else{if(this.q.attachEvent){this.q.attachEvent(\"onfocusin\",this._visible);this.q.attachEvent(\"onfocusout\",this._hidden)}}}else{this.q.addEventListener(this.cachedPrefix+this.props[1],function(){window.visibly._nativeSwitch.apply(window.visibly,arguments)},1)}}catch(i){}},init:function(){this.getPrefix();this._listen()}};this.visibly.init()})();\n\n    function random() {\n      return Math.round(Math.random() * 2147483647);\n    }\n\n    /*\n     * Constructors\n     */\n\n    function Field(elem) {\n      this.selector = elem.selector;\n      $elem = this.$elem = $(elem.selector);\n      this.name = elem.name;\n\n      this.top = $elem.offset().top;\n      this.height = $elem.height();\n      this.bottom = this.top + this.height;\n      this.width = $elem.width();\n    }\n\n    function Viewport() {\n      var $window = $(window);\n\n      this.top = $window.scrollTop();\n      this.height = $window.height();\n      this.bottom = this.top + this.height;\n      this.width = $window.width();\n    }\n\n    /*\n     * Do Stuff\n     */\n\n    function sendGAEvent(field, time) {\n\n      if (universalGA) {\n        ga('send', 'event', 'Screentime', 'Time on Screen', field, parseInt(time, 10), {'nonInteraction': true});\n      }\n\n      if (classicGA) {\n        _gaq.push(['_trackEvent', 'Screentime', 'Time on Screen', field, parseInt(time, 10), true]);\n      }\n\n    }\n\n    function onScreen(viewport, field) {\n      var cond, buffered, partialView;\n\n      // Field entirely within viewport\n      if ((field.bottom <= viewport.bottom) && (field.top >= viewport.top)) {\n        return true;\n      }\n\n       // Field bigger than viewport\n      if (field.height > viewport.height) {\n\n        cond = (viewport.bottom - field.top) > (viewport.height / 2) && (field.bottom - viewport.top) > (viewport.height / 2);\n\n        if (cond) {\n          return true;\n        }\n\n      }\n\n      // Partially in view\n      buffered = (field.height * (options.percentOnScreen/100));\n      partialView = ((viewport.bottom - buffered) >= field.top && (field.bottom - buffered) > viewport.top);\n\n      return partialView;\n\n    }\n\n    function checkViewport() {\n      var viewport = new Viewport();\n\n      $.each(cache, function(key, val) {\n        if (onScreen(viewport, val)) {\n          log[key] += 1;\n          counter[key] += 1;\n        }\n      });\n\n    }\n\n    function report() {\n\n      var data = {};\n\n      $.each(counter, function(key, val) {\n        if (val > 0) {\n          data[key] = val;\n          counter[key] = 0;\n\n          if (options.googleAnalytics) {\n            sendGAEvent(key, val);\n          }\n\n        }\n      });\n\n      if (!$.isEmptyObject(data)) {\n        options.callback.call(this, data, log);\n      }\n\n    }\n\n    function startTimers() {\n\n      if (!started) {\n        checkViewport();\n        started = true;\n      }\n\n      looker = setInterval(function() {\n        checkViewport();\n      }, 1000);\n\n      reporter = setInterval(function() {\n        report();\n      }, options.reportInterval * 1000);\n\n    }\n\n    function stopTimers() {\n      clearInterval(looker);\n      clearInterval(reporter);\n    }\n\n    $.screentime.reset = function() {\n      stopTimers();\n\n      $.each(cache, function(key, val) {\n        log[key] = 0;\n        counter[key] = 0;\n      });\n\n      startTimers();\n    }\n\n    function init() {\n\n      $.each(options.fields, function(index, elem) {\n        if ($(elem.selector).length) {\n          var field = new Field(elem);\n          cache[field.name] = field;\n          counter[field.name] = 0;\n          log[field.name] = 0;\n        }\n      });\n\n      startTimers();\n\n      visibly.onHidden(function() {\n        stopTimers();\n      });\n\n      visibly.onVisible(function() {\n        stopTimers();\n        startTimers();\n      });\n\n    }\n\n    init();\n\n  };\n\n}));\n"]}